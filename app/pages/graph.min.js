(function(){var t,e,r,a=function(t,e){return function(){return t.apply(e,arguments)}},i=[].indexOf||function(t){for(var e=0,r=this.length;e<r;e++)if(e in this&&this[e]===t)return e;return-1};r=pimatic.tryCatch,t=Array.prototype.concat,LazyLoad.js(t.apply(scripts.dygraph,scripts.datepicker)),$(document).on("pagecreate","#graph-page",function(t){var e,n,o;n=function(){function t(){}return t.prototype.query=[],t.prototype.addTask=function(t,e){return null==e&&(e=!1),t.onComplete=function(e){return function(){return t.status="complete",e.next()}}(this),e?this.query.unshift(t):this.query.push(t),this.start()},t.prototype.start=function(){var t;if(0!==this.query.length&&"running"!==(t=this.query[0]).status)return t.status="running",t.start()},t.prototype.next=function(){var t;return this.query=function(){var e,r,a,i;for(i=[],e=0,r=(a=this.query).length;e<r;e++)"complete"!==(t=a[e]).status&&i.push(t);return i}.call(this),this.start()},t.prototype.clear=function(){var t,e,r,a;for(t=0,e=(r=this.query).length;t<e;t++)null!=(a=r[t]).abort&&a.abort(),a.status="aborted";return this.query.length=0},t}(),e=function(){function t(){this.saveCollapseState=a(this.saveCollapseState,this),this.isGroupCollapsed=a(this.isGroupCollapsed,this),this.toggleGroup=a(this.toggleGroup,this),this.afterRenderAttribute=a(this.afterRenderAttribute,this);var t,e;ko.computed(r(function(t){return function(){var e,r,a;if(!t.pageCreated())return!1;for(e=0,r=(a=pimatic.groups()).length;e<r;e++)a[e].devices();return pimatic.try(function(){return $("#graph-device-list").listview("refresh")})}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}}),this.averageDurationText=ko.computed(r(function(t){return function(){return __("Average values of %s.",t.averageDuration())}}(this))),this.chosenDate($.datepicker.formatDate(this.dateFormat,new Date)),e=pimatic.storage.get("pimatic.graph")||{},this.collapsedGroups=ko.observable(e.collapsed||{}),t=function(t){return"boolean"===t.type?"__state":t.unit},ko.computed(r(function(r){return function(){var a,n,o,u,s,l,c,p,h,d,g,f,b,m,v,y,D,k,w,x,A,T,C,F,L,S,G,R,_,q,B,P,M,O,Q,W,I,N,E,j,z,V,H,U;if(0===(p=r.displayedAttributes()).length)return null!=r.chart&&(r.chart.destroy(),r.chart=null),$("#chart").hide(),$("#chart-info").hide(),void $("#chart-no-data").hide();if(_=0,Q=[],R=p.filter(function(t){return"number"===t.attribute.type}),R=R.concat(p.filter(function(t){return"boolean"===t.attribute.type})),p=R,r.dataLoadingQuery.clear(),B=r.chosenRange(),c=r.chosenDate(),null!=$.datepicker.parseDate(r.dateFormat,c)){for(g=r.getGroupByTimeForRange(B),r.averageDuration(r.timeDurationToText(g)),j=[],z=[],y=0,w=p.length;y<w;y++)(v=p[y]).added=!1,v.range===B&&v.chosenDate===c||(v.range=null,v.data=null),E=t(v.attribute),"boolean"===v.attribute.type&&(Q[_]=v.attribute,v.stateOffset=_,_++),i.call(j,E)<0&&(j.push(E),z[E]=v.attribute);for(U=[],O=function(t){var e,r;return r=Math.floor(t),e=Q[r],t=t!==r,e.formatValue(t)},I=[],s=D=0,x=Q.length;D<x;s=++D)o=Q[s],I.push({v:s,label:o.labels[1]}),I.push({v:s+.5,label:o.labels[0]});for(W=function(){return I},h=function(t){var e,r,a;return a=z[t],"__state"===t?(e=O,r=W):(e=function(t){return a.formatValue(t)},r=Dygraph.numericTicks),U.push({axisLabelFormatter:e,valueFormatter:e,ticker:r})},k=0,A=j.length;k<A;k++)h(j[k]);for(P=r.getDateRange(),N=P.to,d=P.from,u=function(t){return 0===t?"y":"y"+(t+1)},l={labelsDiv:$("#chart-legend")[0],legend:"always",tooltip:"follow",staticLegend:!0,strokeWidth:2,pointSize:3,width:null,height:null,labels:["Date"],showRangeSelector:!0,connectSeparatedPoints:!0,rangeSelectorPlotStrokeColor:r.colors[0],rangeSelectorPlotFillColor:"#e0e6ec",xAxisHeight:35,highlightSeriesBackgroundAlpha:.9,highlightSeriesOpts:{},gridLineColor:"#BDBDBD",series:{},axes:{x:{valueFormatter:function(t){var e;return(e=pimatic.timestampToDateTime(t)).date+" "+e.time},pixelsPerLabel:25,axisTickSize:10}}},f=G=0,T=U.length;G<T;f=++G)H=U[f],l.axes[u(f)]=H;for(n=[],m=!1,V=function(){var t,e,a;return t=$("#chart"),e=$("#chart-no-data"),n.length>0?(e.hide(),m?(a={file:n},null!=l.axes.x.dateWindow&&(a.axes=l.axes),r.chart.updateOptions(a)):(null!=r.chart&&r.chart.destroy(),t.show().css("width","100%"),t.parent().css("padding-right",null!=l.axes.y2?0:"20px"),$("#chart-info").show(),r.chart=new Dygraph(t[0],n,l),m=!0)):e.show()},500,r.addChartData=function(t,e,a){var i,o,u,s,c,h,d,g,b,m,v;if(i=n,h=[],null!=(v=null!=(g=r.chart)?g.xAxisRange():void 0)&&n.length>0&&(s=v[1]===n[n.length-1][0].getTime()),"boolean"===e.attribute.type)for(d=0,c=a.length;d<c;d++)(u=a[d])[1]=u[1]?e.stateOffset+.5:e.stateOffset;if(0===a.length)h=n;else{for(m=a[0][0],o=0,b=0;b<a.length;){for(;o<i.length&&i[o][0].getTime()<m-500;)h.push(i[o]),o++;if(o<i.length&&b<a.length&&Math.abs(a[b][0]-i[o][0].getTime())<=500)i[o][t+1]=a[b][1],h.push(i[o]),o++,++b<a.length&&(m=a[b][0]);else{for((u=new Array(p.length+1))[0]=new Date(a[b][0]),f=1;f<p.length+1;)u[f]=null,f++;u[t+1]=a[b][1],h.push(u),++b<a.length&&(m=a[b][0])}}for(;o<i.length;)h.push(i[o]),o++}return n=h,null!=v&&s&&(v[1]=n[n.length-1][0].getTime(),l.axes.x.dateWindow=v),V()},S=function(t,e,a,i){var n;return"function"!=typeof i&&(i=function(){}),n={attributeName:t.attribute.name,abort:i},n.start=function(){return pimatic.client.rest.querySingleDeviceAttributeEvents({deviceId:t.device.id,attributeName:t.attribute.name,criteria:{before:e,limit:1,order:"time",orderDirection:"desc"}},{global:!1}).done(function(t){if("aborted"!==n.status)return t.success?a(t.events):void 0}).always(function(){if("aborted"!==n.status)return n.onComplete()}).fail(function(){return i()})},r.dataLoadingQuery.addTask(n,!1)},F=100,L=function(t,e,a,i,n,o){var u;return null==o&&(o=!1),"function"!=typeof n&&(n=function(){}),u={attributeName:t.attribute.name,abort:n},u.start=function(){var r;return r=(new Date).getTime(),pimatic.client.rest.querySingleDeviceAttributeEvents({deviceId:t.device.id,attributeName:t.attribute.name,criteria:{after:e,before:a,limit:F,groupByTime:"number"!==t.attribute.type||t.attribute.discrete?void 0:g}},{global:!1}).done(function(e){var o,s,l,c;if("aborted"!==u.status&&e.success){if(o=e.events.length,s=o===F,!(o>0))return i(e.events,!1);if(c=(new Date).getTime()-r,c=Math.max(c,1),F=Math.floor(o*(3e3/c)),F=Math.max(F,100),i(e.events,s),s)return l=e.events[o-1],L(t,l.time+1,a,i,n,!0)}}).always(function(){if("aborted"!==u.status)return u.onComplete()}).fail(function(){return n()})},r.dataLoadingQuery.addTask(u,o)},a=function(a,n){var o,s,p,h,g,f,b,m,v;for(v=ko.utils.arrayIndexOf(j,t(n.attribute)),b=g=n.device.name()+": "+n.attribute.label,f=2;i.call(l.labels,g)>=0;)g=b+" "+f,f++;return m={axis:u(v),stepPlot:n.attribute.discrete,color:r.colors[a%r.colors.length],showInRangeSelector:0===a},"boolean"===n.attribute.type&&(m.strokePattern=Dygraph.DASHED_LINE),n.added=!0,n.chosenDate=c,n.range=B,n.index=a,n.serie(m),l.labels.push(g),l.series[g]=m,V(),o=[],h="loading-series-"+n.device.id+"_"+n.attribute.name,pimatic.loading(h,"show",{text:__("Loading data for "+n.device.name()+": "+n.attribute.label),blocking:!1}),p=function(t){var i,u;return e=function(){var e,r,a,n;for(n=[],r=0,e=t.length;r<e;r++)a=t[r],i=a.time,u=a.value,n.push([i,u]);return n}(),r.addChartData(a,n,e),o=o.concat(e)},s=function(){return L(n,d.getTime(),N.getTime(),function(t,e){p(t),e||(n.data=o,n.range=B,pimatic.loading(h,"hide"))},function(){return pimatic.loading(h,"hide")})},n.attribute.discrete?S(n,d.getTime(),function(t){return 1===t.length&&(t[0].time=d.getTime()),p(t),s()}):s()},M=[],b=q=0,C=p.length;q<C;b=++q)v=p[b],M.push(a(b,v));return M}}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}})}return t.prototype.groups=pimatic.groups,t.prototype.displayedAttributes=ko.observableArray(),t.prototype.dateFrom=ko.observable(),t.prototype.dateTo=ko.observable(),t.prototype.chosenRange=ko.observable("day"),t.prototype.chosenDate=ko.observable(),t.prototype.pageCreated=ko.observable(!1),t.prototype.dataLoadingQuery=new n,t.prototype.averageDuration=ko.observable(null),t.prototype.dateFormat="yy-mm-dd",t.prototype.colors=["#7cb5ec","#434348","#90ed7d","#f7a35c","#8085e9","#f15c80","#e4d354","#8085e8","#8d4653","#91e8e1"],t.prototype.getUngroupedDevicesWithGraphableAttribute=function(){var t,e;return e=pimatic.getUngroupedDevices(),function(){var r,a,i;for(i=[],r=0,a=e.length;r<a;r++)(t=e[r]).hasAttibuteWith(function(t){var e;return"boolean"===(e=t.type)||"number"===e})&&i.push(t);return i}.call(this)},t.prototype.afterRenderAttribute=function(t){var e;return e=$(t).find("select"),pimatic.try(function(){return e.flipswitch()})},t.prototype.getDisplayedAttribute=function(t,e){var r,a,i,n;for(a=0,i=(n=this.displayedAttributes()).length;a<i;a++)if((r=n[a]).device===t&&r.attribute===e)return r;return null},t.prototype.addToDisplayedAttributes=function(t,e){if(null==this.getDisplayedAttribute(t,e))return this.displayedAttributes.push({device:t,attribute:e,serie:ko.observable()})},t.prototype.removeFromDisplayedAttributes=function(t,e){return this.displayedAttributes.remove(function(r){return r.device===t&&r.attribute===e})},t.prototype.isLive=function(){var t,e;return e=new Date,null!==(t=$.datepicker.parseDate(this.dateFormat,this.chosenDate()))&&(t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate())},t.prototype.getDateRange=function(){var t,e,r,a;switch(r=this.chosenRange(),t=$.datepicker.parseDate(this.dateFormat,this.chosenDate()),this.isLive()?a=new Date:(a=new Date(t)).setDate(a.getDate()+1),e=new Date(a),r){case"day":e.setDate(a.getDate()-1);break;case"week":e.setDate(a.getDate()-7);break;case"month":e.setDate(a.getDate()-30);break;case"year":e.setDate(a.getDate()-365)}return{from:e,to:a}},t.prototype.getGroupByTimeForRange=function(t){return function(){switch(t){case"day":return 3e5;case"week":return 18e5;case"month":return 72e5;case"year":return 144e5}}()},t.prototype.timeDurationToText=function(t){var e,r,a,i;return t/=1e3,i="",r=t/60,0!==(a=t%60)&&(i=a+"s "+i),0!==r&&(r<60?0!==r&&(i=r+"min "+i):(e=r/60,i=0!==(r%=60)?e+"h "+r+"min "+i:e+"h "+i)),i.trim()},t.prototype.toggleGroup=function(t){var e;return(e=this.collapsedGroups())[t.id]?delete e[t.id]:e[t.id]=!0,this.collapsedGroups(e),this.saveCollapseState(),!1},t.prototype.isGroupCollapsed=function(t){return!0===this.collapsedGroups()[t.id]},t.prototype.saveCollapseState=function(){var t;return t=pimatic.storage.get("pimatic.graph")||{},t.collapsed=this.collapsedGroups(),pimatic.storage.set("pimatic.graph",t)},t}(),pimatic.pages.graph=o=new e,ko.applyBindings(o,$("#graph-page")[0]),o.pageCreated(!0),$("#graph-page").on("click",".device-attribute-list .show-button",r(function(t){var e,r;e=ko.dataFor(this),r=ko.dataFor($(this).parents(".graph-device")[0]),o.addToDisplayedAttributes(r,e)})),$("#graph-page").on("click",".device-attribute-list .hide-button",r(function(t){var e,r;e=ko.dataFor(this),r=ko.dataFor($(this).parents(".graph-device")[0]),o.removeFromDisplayedAttributes(r,e)}))}),$(document).on("pagebeforeshow","#graph-page",function(t){var e,r,a,i,n,o,u,s,l;if(n=pimatic.pages.graph,r=null!=(o=jQuery.mobile.pageParams)?o.device:void 0,jQuery.mobile.pageParams={},null!=r){for(l=[],a=0,i=(u=r.attributes()).length;a<i;a++)"number"!==(s=(e=u[a]).type)&&"boolean"!==s||l.push({device:r,attribute:e,serie:ko.observable()});n.displayedAttributes(l)}}),e=null,$(document).on("pagehide","#graph-page",function(t){pimatic.pages.graph.dataLoadingQuery.clear(),null!=e&&pimatic.socket.removeListener("deviceAttributeChanged",e)}),$(document).on("pagebeforeshow","#graph-page",function(){var t;return t=pimatic.pages.graph,pimatic.socket.on("deviceAttributeChanged",e=function(e){var r,a,i,n;if(t.isLive())for(a=0,i=(n=t.displayedAttributes()).length;a<i;a++)(r=n[a]).device.id===e.deviceId&&r.attribute.name===e.attributeName&&null!=r.serie&&null!=r.data&&r.added&&null!=r.index&&null!=t.addChartData&&(t.addChartData(r.index,r,[[new Date(e.time).getTime(),e.value]]),pimatic.showToast(__("%s: %s value: %s",r.device.name(),r.attribute.label,r.attribute.formatValue(e.value))))})})}).call(this);